<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions - FinSight Tracker</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <h1>üí∞ FinSight</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="transactions.html" class="active" aria-current="page">üí≥ Transactions</a></li>
                <li><a href="add-transaction.html">‚ûï Add Transaction</a></li>
                <li><a href="budgets.html">üéØ Budgets</a></li>
                <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
            </ul>
            <div class="sidebar-footer">
                <span id="currentUser" class="user-info"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <header class="page-header">
                <h2>Transactions</h2>
                <button class="mobile-menu-toggle" aria-label="Toggle menu">‚ò∞</button>
            </header>

            <div class="transactions-controls">
                <div class="search-box">
                    <input type="search" id="searchInput" placeholder="Search by category, amount, or notes..." 
                           aria-label="Search transactions">
                </div>
                <div class="sort-box">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" aria-label="Sort transactions">
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="amount-desc">Amount (High to Low)</option>
                        <option value="amount-asc">Amount (Low to High)</option>
                        <option value="category-asc">Category (A-Z)</option>
                    </select>
                </div>
                <button id="undoBtn" class="btn btn-secondary" disabled>‚Ü∂ Undo</button>
            </div>

            <!-- Spending Analysis Chart -->
            <div class="card spending-analysis-compact">
                <h3>Spending Analysis</h3>
                <div class="chart-controls">
                    <button class="btn btn-small" data-period="week">Week</button>
                    <button class="btn btn-small active" data-period="month">Month</button>
                    <button class="btn btn-small" data-period="year">Year</button>
                </div>
                <canvas id="spendingAnalysisChart" aria-label="Spending analysis over time"></canvas>
            </div>

            <!-- Transactions List -->
            <div class="card">
                <h3>All Transactions (<span id="transactionCount">0</span>)</h3>
                <div id="transactionsList" class="transactions-list"></div>
                <div id="pagination" class="pagination"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Transactions page functionality for GitHub Pages
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        let currentSort = 'date-desc';
        let currentPeriod = 'month';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load and apply user's theme
            loadUserTheme(currentUser);
            
            // Display user
            document.getElementById('currentUser').textContent = 'üë§ ' + currentUser;
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Mobile menu toggle
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
            }
            
            // Load transactions and setup handlers
            loadTransactions();
            setupTransactionHandlers();
            createSpendingChart();
        });
        
        function loadTransactions() {
            // Get current user
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // If this is a new user, ensure old global data is cleared
            const isNewUser = sessionStorage.getItem('isNewUser');
            if (isNewUser === 'true') {
                console.log('Clearing old global data for new user');
                localStorage.removeItem('transactions');
                localStorage.removeItem('budgets');
            }
            
            // Load user-specific transactions
            allTransactions = getUserTransactions(currentUser);
            filteredTransactions = [...allTransactions];
            renderTransactionsPage();
        }

        // User-specific data management functions
        function getUserTransactions(username) {
            const userKey = `transactions_${username}`;
            const saved = localStorage.getItem(userKey);
            
            if (saved) {
                return JSON.parse(saved);
            } else {
                // Check if this is a new user
                const isNewUser = sessionStorage.getItem('isNewUser');
                
                if (isNewUser === 'true') {
                    // New user gets completely blank app - NO MIGRATION AT ALL
                    console.log('New user detected, providing blank data');
                    sessionStorage.removeItem('isNewUser');
                    localStorage.setItem(userKey, JSON.stringify([]));
                    return [];
                } else {
                    // For existing users, check if we should migrate
                    const migrationKey = `migrated_${username}`;
                    const alreadyMigrated = localStorage.getItem(migrationKey);
                    
                    // Only migrate if not already done AND user has no data
                    if (!alreadyMigrated) {
                        const oldTransactions = localStorage.getItem('transactions');
                        if (oldTransactions) {
                            console.log('Migrating old data for existing user:', username);
                            const transactions = JSON.parse(oldTransactions);
                            localStorage.setItem(userKey, JSON.stringify(transactions));
                            localStorage.setItem(migrationKey, 'true');
                            return transactions;
                        }
                        // Mark as migrated even if no old data
                        localStorage.setItem(migrationKey, 'true');
                    }
                    
                    // Return empty array for users with no data
                    console.log('No data found for user:', username);
                    return [];
                }
            }
        }

        function saveUserTransactions(username, transactions) {
            const userKey = `transactions_${username}`;
            localStorage.setItem(userKey, JSON.stringify(transactions));
        }
        
        function setupTransactionHandlers() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase();
                    if (query) {
                        filteredTransactions = allTransactions.filter(tx => 
                            tx.category.toLowerCase().includes(query) ||
                            tx.note.toLowerCase().includes(query) ||
                            tx.amount.toString().includes(query)
                        );
                    } else {
                        filteredTransactions = [...allTransactions];
                    }
                    currentPage = 1;
                    renderTransactionsPage();
                }, 300);
            });
            
            // Sort functionality
            document.getElementById('sortSelect').addEventListener('change', function(e) {
                currentSort = e.target.value;
                renderTransactionsPage();
            });
            
            // Chart period buttons
            const chartButtons = document.querySelectorAll('.chart-controls button');
            chartButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    chartButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    createSpendingChart();
                });
            });
            
            // Undo button (placeholder)
            document.getElementById('undoBtn').addEventListener('click', function() {
                showToast('Undo functionality coming soon!', 'info');
            });
        }
        
        function renderTransactionsPage() {
            const sorted = sortTransactions(filteredTransactions, currentSort);
            const itemsPerPage = 10;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = sorted.slice(startIndex, endIndex);
            
            // Update count
            document.getElementById('transactionCount').textContent = filteredTransactions.length;
            
            // Render transactions list
            const transactionsList = document.getElementById('transactionsList');
            if (pageItems.length === 0) {
                transactionsList.innerHTML = '<p class="no-transactions">No transactions found.</p>';
            } else {
                transactionsList.innerHTML = pageItems.map(tx => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-category">${tx.category}</div>
                            <div class="transaction-note">${tx.note || 'No note'}</div>
                            <div class="transaction-date">${formatDate(tx.date)} ${tx.time || ''}</div>
                        </div>
                        <div class="transaction-amount ${tx.type}">
                            ${tx.type === 'income' ? '+' : '-'}‚Çπ${tx.amount.toLocaleString()}
                        </div>
                        <div class="transaction-actions">
                            <button onclick="editTransaction(${tx.id})" class="btn btn-small">Edit</button>
                            <button onclick="deleteTransaction(${tx.id})" class="btn btn-small btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Render pagination
            renderPagination(sorted.length, itemsPerPage);
        }
        
        function sortTransactions(transactions, sortBy) {
            const sorted = [...transactions];
            
            switch (sortBy) {
                case 'date-desc':
                    return sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
                case 'date-asc':
                    return sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
                case 'amount-desc':
                    return sorted.sort((a, b) => b.amount - a.amount);
                case 'amount-asc':
                    return sorted.sort((a, b) => a.amount - b.amount);
                case 'category-asc':
                    return sorted.sort((a, b) => a.category.localeCompare(b.category));
                default:
                    return sorted;
            }
        }
        
        function renderPagination(totalItems, itemsPerPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="btn btn-small">Previous</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="btn btn-small active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})" class="btn btn-small">${i}</button>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="btn btn-small">Next</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }
        
        function changePage(page) {
            currentPage = page;
            renderTransactionsPage();
        }
        
        function createSpendingChart() {
            const ctx = document.getElementById('spendingAnalysisChart');
            if (!ctx) return;
            
            // Get real user-specific transaction data
            const currentUser = sessionStorage.getItem('currentUser');
            const userTransactions = allTransactions || [];
            
            console.log('Creating chart for user:', currentUser, 'with', userTransactions.length, 'transactions');
            
            // Generate real data based on user transactions and period
            let labels, incomeData, expenseData;
            
            if (userTransactions.length === 0) {
                // New user or no transactions - show empty chart
                switch (currentPeriod) {
                    case 'week':
                        labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                        break;
                    case 'month':
                        labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                        break;
                    case 'year':
                        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        break;
                }
                incomeData = new Array(labels.length).fill(0);
                expenseData = new Array(labels.length).fill(0);
            } else {
                // Calculate real data from user transactions
                const chartData = calculateChartData(userTransactions, currentPeriod);
                labels = chartData.labels;
                incomeData = chartData.incomeData;
                expenseData = chartData.expenseData;
            }
            
            // Destroy existing chart if it exists
            if (window.spendingChart) {
                window.spendingChart.destroy();
            }
            
            window.spendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ‚Çπ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateChartData(transactions, period) {
            let labels, incomeData, expenseData;
            
            switch (period) {
                case 'week':
                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    incomeData = new Array(7).fill(0);
                    expenseData = new Array(7).fill(0);
                    
                    // Get current week's transactions
                    const now = new Date();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    
                    transactions.forEach(tx => {
                        const txDate = new Date(tx.date);
                        const daysDiff = Math.floor((txDate - startOfWeek) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff < 7) {
                            if (tx.type === 'income') {
                                incomeData[daysDiff] += tx.amount;
                            } else {
                                expenseData[daysDiff] += tx.amount;
                            }
                        }
                    });
                    break;
                    
                case 'month':
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    incomeData = new Array(4).fill(0);
                    expenseData = new Array(4).fill(0);
                    
                    // Get current month's transactions grouped by week
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    
                    transactions.forEach(tx => {
                        const txDate = new Date(tx.date);
                        if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
                            const weekOfMonth = Math.floor((txDate.getDate() - 1) / 7);
                            const weekIndex = Math.min(weekOfMonth, 3);
                            
                            if (tx.type === 'income') {
                                incomeData[weekIndex] += tx.amount;
                            } else {
                                expenseData[weekIndex] += tx.amount;
                            }
                        }
                    });
                    break;
                    
                case 'year':
                    labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    incomeData = new Array(12).fill(0);
                    expenseData = new Array(12).fill(0);
                    
                    // Get current year's transactions grouped by month
                    const year = new Date().getFullYear();
                    
                    transactions.forEach(tx => {
                        const txDate = new Date(tx.date);
                        if (txDate.getFullYear() === year) {
                            const monthIndex = txDate.getMonth();
                            
                            if (tx.type === 'income') {
                                incomeData[monthIndex] += tx.amount;
                            } else {
                                expenseData[monthIndex] += tx.amount;
                            }
                        }
                    });
                    break;
            }
            
            return { labels, incomeData, expenseData };
        }
        
        function editTransaction(id) {
            window.location.href = `edit-transaction.html?id=${id}`;
        }
        
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const currentUser = sessionStorage.getItem('currentUser');
                allTransactions = allTransactions.filter(tx => tx.id !== id);
                filteredTransactions = filteredTransactions.filter(tx => tx.id !== id);
                saveUserTransactions(currentUser, allTransactions);
                renderTransactionsPage();
                showToast('Transaction deleted successfully', 'success');
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add CSS for animations and styling
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .transaction-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px;
                border-bottom: 1px solid #e5e7eb;
                gap: 15px;
            }
            .transaction-info {
                flex: 1;
            }
            .transaction-category {
                font-weight: 600;
                text-transform: capitalize;
                color: #374151;
            }
            .transaction-note {
                font-size: 14px;
                color: #6b7280;
                margin: 2px 0;
            }
            .transaction-date {
                font-size: 12px;
                color: #9ca3af;
            }
            .transaction-amount {
                font-weight: 600;
                font-size: 16px;
                min-width: 120px;
                text-align: right;
            }
            .transaction-amount.income {
                color: #10b981;
            }
            .transaction-amount.expense {
                color: #ef4444;
            }
            .transaction-actions {
                display: flex;
                gap: 5px;
            }
            .no-transactions {
                text-align: center;
                padding: 40px;
                color: #6b7280;
            }
            .pagination {
                display: flex;
                justify-content: center;
                gap: 5px;
                margin-top: 20px;
            }
            .pagination .btn.active {
                background: #4f46e5;
                color: white;
            }
        `;
        document.head.appendChild(style);

        // Theme management functions
        function loadUserTheme(username) {
            const savedTheme = localStorage.getItem(`theme_${username}`) || 'light';
            applyTheme(savedTheme);
            console.log('Applied theme for user:', username, '- Theme:', savedTheme);
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
    </script>
</body>
</html>
