<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions - FinSight Tracker</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <h1>üí∞ FinSight</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="transactions.html" class="active" aria-current="page">üí≥ Transactions</a></li>
                <li><a href="add-transaction.html">‚ûï Add Transaction</a></li>
                <li><a href="budgets.html">üéØ Budgets</a></li>
                <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
            </ul>
            <div class="sidebar-footer">
                <span id="currentUser" class="user-info"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <header class="page-header">
                <h2>Transactions</h2>
                <button class="mobile-menu-toggle" aria-label="Toggle menu">‚ò∞</button>
            </header>

            <div class="transactions-controls">
                <div class="search-box">
                    <input type="search" id="searchInput" placeholder="Search by category, amount, or notes..." 
                           aria-label="Search transactions">
                </div>
                <div class="sort-box">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" aria-label="Sort transactions">
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="amount-desc">Amount (High to Low)</option>
                        <option value="amount-asc">Amount (Low to High)</option>
                        <option value="category-asc">Category (A-Z)</option>
                    </select>
                </div>
                <button id="undoBtn" class="btn btn-secondary" disabled>‚Ü∂ Undo</button>
            </div>

            <!-- Spending Analysis Chart -->
            <div class="card spending-analysis-compact">
                <h3>Spending Analysis</h3>
                <div class="chart-controls">
                    <button class="btn btn-small" data-period="week">Week</button>
                    <button class="btn btn-small active" data-period="month">Month</button>
                    <button class="btn btn-small" data-period="year">Year</button>
                </div>
                <canvas id="spendingAnalysisChart" aria-label="Spending analysis over time"></canvas>
            </div>

            <!-- Transactions List -->
            <div class="card">
                <h3>All Transactions (<span id="transactionCount">0</span>)</h3>
                <div id="transactionsList" class="transactions-list"></div>
                <div id="pagination" class="pagination"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Transactions page functionality for GitHub Pages
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        let currentSort = 'date-desc';
        let currentPeriod = 'month';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // Display user
            document.getElementById('currentUser').textContent = 'üë§ ' + currentUser;
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Mobile menu toggle
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
            }
            
            // Load transactions and setup handlers
            loadTransactions();
            setupTransactionHandlers();
            createSpendingChart();
        });
        
        function loadTransactions() {
            // Load demo transactions or from localStorage
            const saved = localStorage.getItem('transactions');
            if (saved) {
                allTransactions = JSON.parse(saved);
            } else {
                // Demo transactions
                allTransactions = [
                    {
                        id: 1,
                        type: 'expense',
                        category: 'food',
                        amount: 2500,
                        date: '2025-12-10',
                        time: '14:30',
                        note: 'Grocery shopping'
                    },
                    {
                        id: 2,
                        type: 'income',
                        category: 'salary',
                        amount: 50000,
                        date: '2025-12-01',
                        time: '09:00',
                        note: 'Monthly salary'
                    },
                    {
                        id: 3,
                        type: 'expense',
                        category: 'transport',
                        amount: 1000,
                        date: '2025-12-09',
                        time: '08:15',
                        note: 'Metro card recharge'
                    },
                    {
                        id: 4,
                        type: 'expense',
                        category: 'entertainment',
                        amount: 1500,
                        date: '2025-12-08',
                        time: '19:00',
                        note: 'Movie tickets'
                    },
                    {
                        id: 5,
                        type: 'expense',
                        category: 'bills',
                        amount: 3000,
                        date: '2025-12-05',
                        time: '10:00',
                        note: 'Electricity bill'
                    }
                ];
                localStorage.setItem('transactions', JSON.stringify(allTransactions));
            }
            
            filteredTransactions = [...allTransactions];
            renderTransactionsPage();
        }
        
        function setupTransactionHandlers() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase();
                    if (query) {
                        filteredTransactions = allTransactions.filter(tx => 
                            tx.category.toLowerCase().includes(query) ||
                            tx.note.toLowerCase().includes(query) ||
                            tx.amount.toString().includes(query)
                        );
                    } else {
                        filteredTransactions = [...allTransactions];
                    }
                    currentPage = 1;
                    renderTransactionsPage();
                }, 300);
            });
            
            // Sort functionality
            document.getElementById('sortSelect').addEventListener('change', function(e) {
                currentSort = e.target.value;
                renderTransactionsPage();
            });
            
            // Chart period buttons
            const chartButtons = document.querySelectorAll('.chart-controls button');
            chartButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    chartButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    createSpendingChart();
                });
            });
            
            // Undo button (placeholder)
            document.getElementById('undoBtn').addEventListener('click', function() {
                showToast('Undo functionality coming soon!', 'info');
            });
        }
        
        function renderTransactionsPage() {
            const sorted = sortTransactions(filteredTransactions, currentSort);
            const itemsPerPage = 10;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = sorted.slice(startIndex, endIndex);
            
            // Update count
            document.getElementById('transactionCount').textContent = filteredTransactions.length;
            
            // Render transactions list
            const transactionsList = document.getElementById('transactionsList');
            if (pageItems.length === 0) {
                transactionsList.innerHTML = '<p class="no-transactions">No transactions found.</p>';
            } else {
                transactionsList.innerHTML = pageItems.map(tx => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-category">${tx.category}</div>
                            <div class="transaction-note">${tx.note || 'No note'}</div>
                            <div class="transaction-date">${formatDate(tx.date)} ${tx.time || ''}</div>
                        </div>
                        <div class="transaction-amount ${tx.type}">
                            ${tx.type === 'income' ? '+' : '-'}‚Çπ${tx.amount.toLocaleString()}
                        </div>
                        <div class="transaction-actions">
                            <button onclick="editTransaction(${tx.id})" class="btn btn-small">Edit</button>
                            <button onclick="deleteTransaction(${tx.id})" class="btn btn-small btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Render pagination
            renderPagination(sorted.length, itemsPerPage);
        }
        
        function sortTransactions(transactions, sortBy) {
            const sorted = [...transactions];
            
            switch (sortBy) {
                case 'date-desc':
                    return sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
                case 'date-asc':
                    return sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
                case 'amount-desc':
                    return sorted.sort((a, b) => b.amount - a.amount);
                case 'amount-asc':
                    return sorted.sort((a, b) => a.amount - b.amount);
                case 'category-asc':
                    return sorted.sort((a, b) => a.category.localeCompare(b.category));
                default:
                    return sorted;
            }
        }
        
        function renderPagination(totalItems, itemsPerPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="btn btn-small">Previous</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="btn btn-small active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})" class="btn btn-small">${i}</button>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="btn btn-small">Next</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }
        
        function changePage(page) {
            currentPage = page;
            renderTransactionsPage();
        }
        
        function createSpendingChart() {
            const ctx = document.getElementById('spendingAnalysisChart');
            if (!ctx) return;
            
            // Generate sample data based on period
            let labels, incomeData, expenseData;
            
            switch (currentPeriod) {
                case 'week':
                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    incomeData = [0, 0, 0, 0, 50000, 0, 0];
                    expenseData = [500, 800, 1200, 600, 300, 2000, 1500];
                    break;
                case 'month':
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    incomeData = [50000, 0, 0, 0];
                    expenseData = [8000, 6000, 7000, 4000];
                    break;
                case 'year':
                    labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    incomeData = [50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000];
                    expenseData = [30000, 28000, 32000, 25000, 35000, 30000, 28000, 33000, 29000, 31000, 25000, 27000];
                    break;
            }
            
            // Destroy existing chart if it exists
            if (window.spendingChart) {
                window.spendingChart.destroy();
            }
            
            window.spendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function editTransaction(id) {
            window.location.href = `edit-transaction.html?id=${id}`;
        }
        
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                allTransactions = allTransactions.filter(tx => tx.id !== id);
                filteredTransactions = filteredTransactions.filter(tx => tx.id !== id);
                localStorage.setItem('transactions', JSON.stringify(allTransactions));
                renderTransactionsPage();
                showToast('Transaction deleted successfully', 'success');
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add CSS for animations and styling
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .transaction-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px;
                border-bottom: 1px solid #e5e7eb;
                gap: 15px;
            }
            .transaction-info {
                flex: 1;
            }
            .transaction-category {
                font-weight: 600;
                text-transform: capitalize;
                color: #374151;
            }
            .transaction-note {
                font-size: 14px;
                color: #6b7280;
                margin: 2px 0;
            }
            .transaction-date {
                font-size: 12px;
                color: #9ca3af;
            }
            .transaction-amount {
                font-weight: 600;
                font-size: 16px;
                min-width: 120px;
                text-align: right;
            }
            .transaction-amount.income {
                color: #10b981;
            }
            .transaction-amount.expense {
                color: #ef4444;
            }
            .transaction-actions {
                display: flex;
                gap: 5px;
            }
            .no-transactions {
                text-align: center;
                padding: 40px;
                color: #6b7280;
            }
            .pagination {
                display: flex;
                justify-content: center;
                gap: 5px;
                margin-top: 20px;
            }
            .pagination .btn.active {
                background: #4f46e5;
                color: white;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
